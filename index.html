<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hiếu Gà - Hoa Phượng Đỏ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
        
        :root {
            --primary: #FF6B8B;
            --primary-dark: #E54B6B;
            --secondary: #FFC2D1;
            --accent: #8A2BE2;
            --background: #FFF5F7;
            --text: #333333;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Quicksand', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
            background-color: var(--background);
            color: var(--text);
        }
        
        .dark {
            --primary: #FF6B8B;
            --primary-dark: #E54B6B;
            --secondary: #8A2BE2;
            --accent: #FFC2D1;
            --background: #1E1E2E;
            --text: #F8F8F2;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .screen {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background-color: var(--background);
            transition: opacity 0.5s;
        }
        
        #loading-screen {
            justify-content: center;
            background-color: var(--background);
            display: flex;
        }
        
        #logo-container {
            width: 200px;
            height: 200px;
            position: relative;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 80%;
            max-width: 300px;
            height: 12px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 6px;
        }
        
        #menu-screen {
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        
        .menu-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 40px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 300px;
        }
        
        #room-screen {
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        
        .room-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .room-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 24px;
            text-align: center;
        }
        
        .room-code {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }
        
        .player-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 24px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .player-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }
        
        .player-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: var(--accent);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 700;
        }
        
        .player-ready {
            margin-left: auto;
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .ready {
            background-color: var(--success);
        }
        
        .not-ready {
            background-color: var(--warning);
        }
        
        .room-footer {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        
        .room-footer button {
            flex: 1;
        }
        
        #join-room-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 300px;
        }
        
        #join-room-input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            font-size: 16px;
            text-align: center;
            letter-spacing: 2px;
        }
        
        #join-room-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        #game-screen {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 20px;
        }
        
        .joystick {
            width: 120px;
            height: 120px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }
        
        .joystick-handle {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(0, 0, 0, 0.1);
        }
        
        .action-button {
            width: 80px;
            height: 80px;
            background-color: var(--primary);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: none;
        }
        
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 16px;
            z-index: 20;
            display: flex;
            justify-content: space-between;
        }
        
        .player-stats {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .player-health {
            width: 100px;
            height: 8px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            background-color: var(--success);
            width: 100%;
            transition: width 0.3s ease;
        }
        
        .player-flowers {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .flower-icon {
            width: 16px;
            height: 16px;
            background-color: var(--primary);
            border-radius: 50%;
        }
        
        .time-left {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        #results-screen {
            opacity: 0;
            pointer-events: none;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
        }
        
        .results-container {
            background-color: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .results-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 24px;
            text-align: center;
        }
        
        .winners-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .winner-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }
        
        .winner-position {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            margin-right: 16px;
        }
        
        .position-1 {
            background-color: gold;
            color: black;
        }
        
        .position-2 {
            background-color: silver;
            color: black;
        }
        
        .position-3 {
            background-color: #CD7F32;
            color: white;
        }
        
        .winner-name {
            font-weight: 600;
        }
        
        .winner-score {
            margin-left: auto;
            font-weight: 700;
            color: var(--primary);
        }
        
        #server-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 1000;
        }
        
        #username-screen {
            display: flex;
            opacity: 0;
            pointer-events: none;
        }
        
        #username-container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        #username-input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            font-size: 16px;
            width: 100%;
            margin-bottom: 16px;
            text-align: center;
        }
        
        #username-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        #network-error {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--danger);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1001;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen">
            <div id="logo-container">
                <svg id="chicken-logo" width="200" height="200" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="100" cy="100" r="95" fill="#FFF5F7" stroke="#FF6B8B" stroke-width="6"/>
                    <path d="M100,45 C85,45 68,60 70,85 C72,110 90,120 100,120 C110,120 128,110 130,85 C132,60 115,45 100,45Z" fill="#FF6B8B"/>
                    <path d="M70,80 C60,78 50,85 55,95 C60,105 70,100 70,90 Z" fill="white"/>
                    <path d="M130,80 C140,78 150,85 145,95 C140,105 130,100 130,90 Z" fill="white"/>
                    <circle cx="75" cy="87" r="5" fill="#333"/>
                    <circle cx="125" cy="87" r="5" fill="#333"/>
                    <path d="M100,100 Q110,110 100,120 Q90,110 100,100Z" fill="#E54B6B"/>
                    <path d="M90,140 L100,130 L110,140 L100,150 Z" fill="#E54B6B"/>
                    <path d="M85,140 Q65,150 65,170 Q85,160 90,162 Z" fill="#FF6B8B"/>
                    <path d="M115,140 Q135,150 135,170 Q115,160 110,162 Z" fill="#FF6B8B"/>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-center text-pink-500 mb-4">Hiếu Gà</h1>
            <p class="text-lg text-center text-gray-600 mb-6">Hoa Phượng Đỏ</p>
            <div class="progress-bar">
                <div class="progress-fill" id="loading-progress"></div>
            </div>
        </div>
        
        <!-- Username Screen -->
        <div id="username-screen" class="screen">
            <div id="username-container">
                <h2 class="text-xl font-bold mb-4">Nhập tên người chơi</h2>
                <input type="text" id="username-input" placeholder="Nhập tên của bạn" maxlength="15">
                <button id="confirm-username-btn">Xác Nhận</button>
            </div>
        </div>
        
        <!-- Menu Screen -->
        <div id="menu-screen" class="screen">
            <h1 class="menu-title">Hiếu Gà<br><span class="text-xl">Hoa Phượng Đỏ</span></h1>
            <div class="menu-buttons">
                <button id="create-room-btn">Tạo Phòng</button>
                <button id="join-room-btn">Vào Phòng</button>
                <div id="join-room-container" style="display: none;">
                    <input type="text" id="join-room-input" placeholder="Nhập mã phòng" maxlength="6">
                    <button id="confirm-join-btn">Xác Nhận</button>
                    <button id="back-to-menu-btn">Quay Lại</button>
                </div>
            </div>
        </div>
        
        <!-- Room Screen -->
        <div id="room-screen" class="screen">
            <div class="room-container">
                <h2 class="room-title">Phòng Chờ</h2>
                <div class="room-code" id="room-code">ABC123</div>
                <p class="text-center mb-4">Chia sẻ mã phòng với bạn bè</p>
                <div class="player-list" id="player-list">
                    <!-- Players will be added dynamically -->
                </div>
                <p class="text-center mb-4" id="player-count">Đang chờ người chơi... (1/5)</p>
                <div class="room-footer">
                    <button id="leave-room-btn" class="bg-gray-500">Rời Phòng</button>
                    <button id="start-game-btn">Bắt Đầu</button>
                    <button id="ready-btn">Sẵn Sàng</button>
                </div>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div id="game-ui">
                <div class="player-stats">
                    <div class="player-avatar" style="width: 24px; height: 24px;">H</div>
                    <div class="player-health">
                        <div class="health-fill" id="health-bar"></div>
                    </div>
                    <div class="player-flowers">
                        <div class="flower-icon"></div>
                        <span id="flower-count">0</span>
                    </div>
                </div>
                <div class="time-left">
                    <span id="time-display">2:00</span>
                </div>
            </div>
            
            <div id="controls">
                <div class="joystick" id="joystick">
                    <div class="joystick-handle" id="joystick-handle"></div>
                </div>
                <button class="action-button" id="action-button">Hoa</button>
            </div>
        </div>
        
        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <div class="results-container">
                <h2 class="results-title">Kết Quả</h2>
                <div class="winners-list" id="winners-list">
                    <!-- Winners will be added dynamically -->
                </div>
                <button id="back-to-menu-from-results">Quay Lại Menu</button>
            </div>
        </div>
        
        <!-- Server Status Indicator -->
        <div id="server-status">Đang kết nối...</div>
        
        <!-- Network Error Message -->
        <div id="network-error">Lỗi kết nối, đang thử lại...</div>
        
        <!-- Game Canvas -->
        <canvas id="game-canvas"></canvas>
    </div>
    
    <script>
        // Detect dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Sound effects
        const sounds = {
            click: new Howl({
                src: ['data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+NAwAAAAAAAAAAAAFhpbmcAAAAPAAAAAwAABBgAa2trawAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/jYMQAEvgiwl9DAAAAO1ALSItIfLvC+HwfB8HwfT8Pz8Hqpq+HEPTnP/0gDLGiEhGYeAMYjGIxiBMAkCQJAkCSRJ8/jj+HEHDHEEAE4UAQBAHw+D8fl8HwfBIBgQDhwQDgwBCqaUiES0ppUPkApkFPkAiMKuIIb0GgMWvJzsACTk6mOfbN0PCF5oHGk3iwjVc5iNaClcGvOmXGo5lHUFSa8qR2MDqpqMHDaijM5y8lmrEoiGh6Azg7KFkW+dQnFAMGMk43J9jlPBaEEhKRZI4TZDTlG5KR7JcRGxNyj6F4TUVkWkSRGEukSEzJcRRGHklyhGJIhGJEpEkZlSBCSR//8iQlIfQhEiETP0SIhkQkRf/ixL//xIi+RIn/+JEX//EiL//iRF//xiRF//xiRF//pERf/6REX//OIn/+cRP/84if/5xE//ziJJEkiSRJIkkP/8IYcEOIM4QgwbUV2GKhBhAQIYYmDFrhS0VWFLmYiRCJkkRJIiSREkiJJEX/+JEX/+JEkSSIkkRf/4kRf/4kRJIiSREkiJJESf/4kRJIiX0ISIl9CEiIWkqS0iSJIAA'],
                volume: 0.5
            }),
            flower: new Howl({
                src: ['data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+NAwAAAAAAAAAAAAFhpbmcAAAAPAAAAAwAABBgAa2trawAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/jYMQAEvgiwl9DAAAAO1ALSItIfLvC+HwfB8HwfT8Pz8Hqpq+HEPTnP/0gDLGiEhGYeAMYjGIxiBMAkCQJAkCSRJ8/jj+HEHDHEEAE4UAQBAHw+D8fl8HwfBIBgQDhwQDgwBCqaUiES0ppUPkApkFPkAcMo5MIcL2c0JKLmgyFwbNlTqJdIrF5WEgUcpwLVhWWCpHh2VSkGS+ItQZIdJWbC2zrGwxqIzBhEMGtQ8O1JYdLhdQhQZVSRJQaiTTokwxhCVK0xXJE0l0VMi8jqJstO0+ixIk8k8SWHUnMkyMRYeRkSPEmRXJ6TibI3kxIjSXyTREYSWJCETImRNEYkSITNEQiRIhExKSInSJf/8SJCRFKEhCRGJmVMSEUkRf/9CL//kSL//iRF//JEX/+JEX//GJF//xiRF//pERf/6REX//OIn/+cRP/84if/5xE//ziJ//nET//OIn/+cRP/84if/5EgghxBBhGJGIYYdJx2MOkREESRJIkmSRJMkySZJkkyTJJkmSbJIhwQZEcY4hxO4YQw5yFDBniCGDPDiYQeGKQdFTJJESSIknCJIif/4kRJIiSRE//xIiSRF//iRF//iRF//iRF//iRF//JEX/+JETSJI0iSNIif/4kRf/4kRJIiSREkiJJESf/4AP'],
                volume: 0.3
            }),
            damage: new Howl({
                src: ['data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+NAwAAAAAAAAAAAAFhpbmcAAAAPAAAAAwAABBgAa2trawAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/jYMQAEvgiwl9DAAAAO1ALSItIfLvC+HwfB8HwfT8Pz8Hqpq+HEPTnP/0gDLGiEhGYeAMYjGIxiBMAkCQJAkCSRJ8/jj+HEHDHEEAE4UAQBAHw+D8fl8HwfBIBgQDhwQDgwBCqaUiES0ppUPkApkFPkAcMZACodIRQGt5r3w4ZiV4eFhKG1xwM4rNJhUWDQ9FgnN51JuEhSNCsXEglNR4JzEYiIxFAuNhcVCY1HY6LBsKRUbTYVCgzFokKRsblpkPh4akZkLjMUDIxKxCO0wHZCLxGGTiZS4jBpVLzMhIxMUTA0FQkOUsJT5UiSJyiYGZNJHkPiaR8iVkXiS0l9FWRWJI0khhKSJ4jEiSMynZEiEzJMi+RiLJORJEYizf/+RIi+hCJExMymZkSEjEiL/+hF//yJF//xIi//kiL//EiL//jEi//4xIi//0iIv/9IiL//nET//OIn/+cRP/84if/5xE//ziJ//nET//OIn/+cRP/84i//xiMJBDiCDCdxjCFqGMMGb0IQgIQRLjjnCEqYQoAciSTJKkiSRJEkSLJEZ//JxIcGBGEMMI2GEMIUIcY1qIxJEkSJJkSSJJkSSZJkmSZJsEiL/+SIkkRJIiSRJxE//xIiT/4kRJIiSREkiJJESf/4AP'],
                volume: 0.4
            }),
            win: new Howl({
                src: ['data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+NAwAAAAAAAAAAAAFhpbmcAAAAPAAAAAwAABBgAa2trawAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/jYMQAEvgiwl9DAAAAO1ALSItIfLvC+HwfB8HwfT8Pz8Hqpq+HEPTnP/0gDLGiEhGYeAMYjGIxiBMAkCQJAkCSRJ8/jj+HEHDHEEAE4UAQBAHw+D8fl8HwfBIBgQDhwQDgwBCqaUiES0ppUPkApkFPkAcMZRQcPFAjFRkLhgaE5mOh4bF4zFwkExgLhoamgiGhaNhSZmRYJzcRDYpGwlGRqOBiWiEQmQuLDMXDA3HR2SCU2mguLDIdCcxHSKVkgmMhWSkQuNSGZiQbGYjGJNIxIWFUqMhsYiMak8kN56MBELSImFxONTAdFJWSF8lIx2TmAmFh0UC4amo4JRCNCQjNJ6JxkZDomJCcUkBEJCY6IRWWmhdKy4mEYj/+JGRIn//IyJE///JF//5Iv//JF//5E//5Iv//JF//5Iv//JMiRMTEsiL//yJicmJ//xJEv/6Iv//JP//kS//8kS//8iX//Ii//5Ev/+RL//iS//4kcQ4g4l/EIRx2MQtSpLq1QiYnJ5BiccmGEqRHEkVKjEViRKkRRJEqRMkTEsSR//0RL//iJf/8RL//iJf/8RL//SJf/6RL//SE//yE//xEQQz/8ERBDiDiCPiHGFTEFTDiKtLHSXEmVJkyIbEmVJlSZMmTJkyZMmUJkyZQmUJlCZMoP/8AA'],
                volume: 0.6
            }),
            connect: new Howl({
                src: ['data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+NAwAAAAAAAAAAAAFhpbmcAAAAPAAAAAwAABBgAa2trawAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/jYMQAEvgiwl9DAAAAO1ALSItIfLvC+HwfB8HwfT8Pz8Hqpq+HEPTnP/0gDLGiEhGYeAMYjGIxiBMAkCQJAkCSRJ8/jj+HEHDHEEAE4UAQBAHw+D8fl8HwfBIBgQDhwQDgwBCqaUiES0ppUPkApkFPkAcJGQkMHg0ODgNhwHBoLiwXnI7NRQKDAOk3NzERC0RFo9IRWIRGOhoKBCaDIcE4YHYlHgsF4lKBKFTQZCrxHiEjD/xiRkTJGRJExP/+JEiRF//iRIkRJE//4kSJEX//EiRIiSJkTJCb/0I//MiZGSJP/9IX/9CP/+JEiRF//iREkSJEn/+JE//4kSJESSJEiL//ESRESNIkIxQJQoJQwJQ4L1YKRSRKGvEpE4kU04dJE2lkSXxIpLEiZImSJkmLJWkRRJfI+kT/+Jk//+JkjI//xImSIkib//Eif/8SJkSJJEiRF//yJF//xIiSJ//iJF//xIl//xIl//xIn/+IkX/+Ii//yIn//GIn/+Ikp4h0EQgS0EQg6EIQ7iohKEuoiEIQ5UIQpCEIQpCn4QpCFISpCEIQpDYWKsKZxCEKXpCnxCEMcpSFIQpTYhCGP/Eh/+4Sh14iqn4Q5ClPTxE1QlD4Qz/8Q//8c//kPhSP/zDr/3D//xD/8Yn/+MMviEOg7/8QhD4Qzm0hDv/xELjELj/+MR///En//ER//GI3/+IjiREkSJESf/4kSJESSJEiL//iRIkRJIkSIv//AA=='],
                volume: 0.3
            }),
            disconnect: new Howl({
                src: ['data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+NAwAAAAAAAAAAAAFhpbmcAAAAPAAAAAwAABBgAa2trawAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/jYMQAEvgiwl9DAAAAO1ALSItIfLvC+HwfB8HwfT8Pz8Hqpq+HEPTnP/0gDLGiEhGYeAMYjGIxiBMAkCQJAkCSRJ8/jj+HEHDHEEAE4UAQBAHw+D8fl8HwfBIBgQDhwQDgwBCqaUiES0ppUPkApkFPkAcKjQ0MDg4ODsYmYvJSwUCsXjEOiYYCDx3o0MRcURmbEo4IRsSkooHSQTicoio2JRgaCwUicJBWOygUigSkYnKBKEzQZCsOE4iE4f/ER/+Jk5MiZIiSJ//iREkSJEn/+JESRMkRJE3/+RMkRJESRMkRJK//yJkiJImSJkiJJX/+REkTJESRF//kRJESREkRf/5ESREkRJEX/+REkRJESRF//kRIkRIiiUZSLUq1tVIq0JQoJQ4JQwJQoKQwHcRLUlEsTiUTSU1ZQHQUBwTjIjC4lHwiLReCIvE4QEoiE5xL5rqtIi+TOJSIRNI0inPImkpqSTUJSJnEpixHMRyM5EIjEIjfURIjeREWojmv/yIv/8iN/8iL/+In/+Inr4jfPiN6+I3z4imIhCFIZCFKZSFKayFKZDIQpDKZDYQpkNhCmQyGwhCmQ2EKQyGQhSGUyEMhnMpDIQpkNpCFMptIQpTKbCFMpkMhDKZDIZDqZT//EQ//Ec//Mf//ET//Ec//MP/yH/7D//yH/7h//5D/9y//8h//Zf/+Q//c3//If/2b//iH/9l//5j//yH/7mP/4iLYhEnUitP/5ESRLSESREkRJESf/4kRJESRIn/+JERJEkRJESf/8AA='],
                volume: 0.3
            })
        };
        
        // Game Assets
        const ASSETS = {
            chickenAvatar: 'data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="19" fill="%23FFF5F7" stroke="%23FF6B8B" stroke-width="2"/><path d="M20,9 C17,9 13.6,12 14,17 C14.4,22 18,24 20,24 C22,24 25.6,22 26,17 C26.4,12 23,9 20,9Z" fill="%23FF6B8B"/><path d="M14,16 C12,15.6 10,17 11,19 C12,21 14,20 14,18 Z" fill="white"/><path d="M26,16 C28,15.6 30,17 29,19 C28,21 26,20 26,18 Z" fill="white"/><circle cx="15" cy="17.4" r="1" fill="%23333"/><circle cx="25" cy="17.4" r="1" fill="%23333"/><path d="M20,20 Q22,22 20,24 Q18,22 20,20Z" fill="%23E54B6B"/><path d="M18,28 L20,26 L22,28 L20,30 Z" fill="%23E54B6B"/><path d="M17,28 Q13,30 13,34 Q17,32 18,32.4 Z" fill="%23FF6B8B"/><path d="M23,28 Q27,30 27,34 Q23,32 22,32.4 Z" fill="%23FF6B8B"/></svg>',
            flower: 'data:image/svg+xml;utf8,<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="10" cy="10" r="5" fill="%23FF6B8B"/><circle cx="10" cy="10" r="3" fill="%23FFC2D1"/><path d="M10,3 Q12,6 15,5 Q13,7 15,10 Q12,9 10,12 Q8,9 5,10 Q7,7 5,5 Q8,6 10,3Z" fill="%23FF6B8B"/></svg>',
            powerup: 'data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="%238A2BE2" fill-opacity="0.7"/><path d="M12,6 L14,10 L18,11 L15,14 L16,18 L12,16 L8,18 L9,14 L6,11 L10,10 Z" fill="white"/></svg>',
            heart: 'data:image/svg+xml;utf8,<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12,21 C12,21 4,16 4,10 C4,7 6,5 9,5 C10.5,5 12,6 12,7.5 C12,6 13.5,5 15,5 C18,5 20,7 20,10 C20,16 12,21 12,21 Z" fill="%23F44336"/></svg>',
            obstacleTree: 'data:image/svg+xml;utf8,<svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M30,10 Q40,20 40,40 L35,40 L35,55 L25,55 L25,40 L20,40 Q20,20 30,10Z" fill="%23795548"/><circle cx="30" cy="20" r="15" fill="%23FF6B8B"/></svg>',
            obstacleBush: 'data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="20" cy="25" rx="18" ry="12" fill="%234CAF50"/><ellipse cx="20" cy="20" rx="15" ry="13" fill="%238BC34A"/><ellipse cx="20" cy="15" rx="12" ry="8" fill="%234CAF50"/><circle cx="20" cy="10" r="5" fill="%238BC34A"/></svg>',
            obstacleRock: 'data:image/svg+xml;utf8,<svg width="50" height="50" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10,35 L15,20 L25,15 L35,20 L40,30 L35,40 L20,45 L10,35Z" fill="%23607D8B"/><path d="M15,25 L25,20 L35,25 L35,35 L25,40 L15,35 Z" fill="%2378909C"/></svg>'
        };
        
        // WebSocket connection
        let socket;
        let socketReconnectTimer;
        let isRoomHost = false;
        let currentRoomCode = null;
        let playerId = null;
        let playerSessionId = null;
        let isConnecting = false;
        let serverUrl = 'wss://serversocket-production.up.railway.app'; // Change to your WebSocket server URL
        
        // Game variables
        let app;
        let gameState = 'loading';
        let playerEntity;
        let entities = [];
        let gameTimer = 120; // 2 minutes in seconds
        let safeRadius = 1000;
        let playerName = "Hiếu Gà";
        let flowerCount = 0;
        let playerHealth = 100;
        let remotePlayers = new Map(); // Map of player ID to player data
        let isPlayerReady = false;
        let timerInterval = null;
        
        // Game setup
        window.addEventListener('load', () => {
            initLoadingScreen();
        });
        
        function initLoadingScreen() {
            console.log("Starting loading screen");
            // Initialize game first to avoid timing issues
            initGame();
            setupEventListeners();
            
            const progressBar = document.getElementById('loading-progress');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    console.log("Loading complete, transitioning to menu");
                    // Use direct style changes instead of relying on opacity transitions
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('username-screen').style.display = 'flex';
                    document.getElementById('username-screen').style.opacity = '1';
                    document.getElementById('username-screen').style.pointerEvents = 'auto';
                    gameState = 'username';
                    
                    // Try to connect to WebSocket server
                    connectToServer();
                }
            }, 250); // 5 seconds total loading time
        }
        
        function initGame() {
            // Initialize PIXI.js
            app = new PIXI.Application({ 
                width: window.innerWidth, 
                height: window.innerHeight,
                backgroundAlpha: 0,
                antialias: true,
                resolution: window.devicePixelRatio || 1
            });
            
            document.getElementById('game-canvas').appendChild(app.view);
            
            // Handle resize
            window.addEventListener('resize', () => {
                app.renderer.resize(window.innerWidth, window.innerHeight);
                if (playerEntity && gameState === 'playing') {
                    centerCamera();
                }
            });
        }
        
        function setupEventListeners() {
            // Username screen
            document.getElementById('confirm-username-btn').addEventListener('click', () => {
                sounds.click.play();
                const username = document.getElementById('username-input').value.trim();
                if (username.length > 0) {
                    playerName = username;
                    document.getElementById('username-screen').style.opacity = '0';
                    document.getElementById('username-screen').style.pointerEvents = 'none';
                    document.getElementById('menu-screen').style.display = 'flex';
                    document.getElementById('menu-screen').style.opacity = '1';
                    document.getElementById('menu-screen').style.pointerEvents = 'auto';
                    gameState = 'menu';
                    
                    // Register player with server
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            type: 'register',
                            name: playerName
                        }));
                    }
                }
            });
            
            // Menu buttons
            document.getElementById('create-room-btn').addEventListener('click', () => {
                sounds.click.play();
                createRoom();
            });
            
            document.getElementById('join-room-btn').addEventListener('click', () => {
                sounds.click.play();
                document.querySelector('.menu-buttons').style.display = 'none';
                document.getElementById('join-room-container').style.display = 'flex';
            });
            
            document.getElementById('confirm-join-btn').addEventListener('click', () => {
                sounds.click.play();
                const roomCode = document.getElementById('join-room-input').value.toUpperCase();
                if (roomCode.length === 6) {
                    joinRoom(roomCode);
                }
            });
            
            document.getElementById('back-to-menu-btn').addEventListener('click', () => {
                sounds.click.play();
                document.getElementById('join-room-container').style.display = 'none';
                document.querySelector('.menu-buttons').style.display = 'flex';
            });
            
            // Room buttons
            document.getElementById('leave-room-btn').addEventListener('click', () => {
                sounds.click.play();
                leaveRoom();
            });
            
            document.getElementById('start-game-btn').addEventListener('click', () => {
                sounds.click.play();
                startGame();
            });
            
            document.getElementById('ready-btn').addEventListener('click', () => {
                sounds.click.play();
                toggleReady();
            });
            
            // Results buttons
            document.getElementById('back-to-menu-from-results').addEventListener('click', () => {
                sounds.click.play();
                document.getElementById('results-screen').style.opacity = '0';
                document.getElementById('results-screen').style.pointerEvents = 'none';
                document.getElementById('results-screen').style.display = 'none';
                document.getElementById('menu-screen').style.display = 'flex';
                document.getElementById('menu-screen').style.opacity = '1';
                document.getElementById('menu-screen').style.pointerEvents = 'auto';
                gameState = 'menu';
            });
            
            // Touch controls
            setupTouchControls();
        }
        
        function setupTouchControls() {
            const joystick = document.getElementById('joystick');
            const handle = document.getElementById('joystick-handle');
            const actionButton = document.getElementById('action-button');
            
            let joystickActive = false;
            let joystickPos = { x: 0, y: 0 };
            const joystickRadius = 60;
            
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = joystick.getBoundingClientRect();
                joystickActive = true;
                updateJoystickPosition(touch, rect);
            });
            
            joystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive) {
                    const touch = e.touches[0];
                    const rect = joystick.getBoundingClientRect();
                    updateJoystickPosition(touch, rect);
                }
            });
            
            joystick.addEventListener('touchend', () => {
                joystickActive = false;
                handle.style.transform = 'translate(-50%, -50%)';
                joystickPos = { x: 0, y: 0 };
                
                // Send stop movement to server
                if (socket && socket.readyState === WebSocket.OPEN && gameState === 'playing') {
                    socket.send(JSON.stringify({
                        type: 'move',
                        vx: 0,
                        vy: 0
                    }));
                }
            });
            
            actionButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                actionButton.style.transform = 'scale(0.9)';
                collectFlower();
            });
            
            actionButton.addEventListener('touchend', () => {
                actionButton.style.transform = 'scale(1)';
            });
            
            function updateJoystickPosition(touch, rect) {
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let dx = touch.clientX - centerX;
                let dy = touch.clientY - centerY;
                
                // Calculate distance from center
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // Normalize if outside of radius
                if (distance > joystickRadius) {
                    dx = (dx / distance) * joystickRadius;
                    dy = (dy / distance) * joystickRadius;
                }
                
                // Update handle position
                handle.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                
                // Normalize joystick position for game input (-1 to 1)
                joystickPos = {
                    x: dx / joystickRadius,
                    y: dy / joystickRadius
                };
                
                // Send movement to server
                if (socket && socket.readyState === WebSocket.OPEN && gameState === 'playing') {
                    socket.send(JSON.stringify({
                        type: 'move',
                        vx: joystickPos.x * 5, // Speed factor
                        vy: joystickPos.y * 5  // Speed factor
                    }));
                }
            }
            
            // Update player movement based on joystick input
            app.ticker.add(() => {
                if (gameState === 'playing' && playerEntity && joystickActive) {
                    const speed = 5;
                    playerEntity.vx = joystickPos.x * speed;
                    playerEntity.vy = joystickPos.y * speed;
                } else if (gameState === 'playing' && playerEntity && !joystickActive) {
                    playerEntity.vx = 0;
                    playerEntity.vy = 0;
                }
            });
        }
        
        function connectToServer() {
            if (isConnecting) return;
            isConnecting = true;
            
            updateServerStatus('Đang kết nối...');
            
            // Close existing connection if any
            if (socket) {
                socket.close();
            }
            
            // Create new WebSocket connection
            socket = new WebSocket(serverUrl);
            
            socket.onopen = function() {
                console.log('Connected to server');
                sounds.connect.play();
                updateServerStatus('Đã kết nối');
                hideNetworkError();
                isConnecting = false;
                
                // Generate a session ID if we don't have one
                if (!playerSessionId) {
                    playerSessionId = generateSessionId();
                }
                
                // Register player if already has a name
                if (gameState !== 'username' && playerName) {
                    socket.send(JSON.stringify({
                        type: 'register',
                        name: playerName,
                        sessionId: playerSessionId
                    }));
                }
                
                // Rejoin room if was in a room
                if (currentRoomCode) {
                    socket.send(JSON.stringify({
                        type: isRoomHost ? 'create_room' : 'join_room',
                        roomCode: currentRoomCode,
                        name: playerName,
                        sessionId: playerSessionId
                    }));
                }
            };
            
            socket.onclose = function() {
                console.log('Disconnected from server');
                sounds.disconnect.play();
                updateServerStatus('Mất kết nối');
                showNetworkError();
                isConnecting = false;
                
                // Try to reconnect after a delay
                if (!socketReconnectTimer) {
                    socketReconnectTimer = setTimeout(() => {
                        socketReconnectTimer = null;
                        connectToServer();
                    }, 3000);
                }
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                isConnecting = false;
                showNetworkError();
            };
            
            socket.onmessage = function(event) {
                handleServerMessage(event.data);
            };
        }
        
        function updateServerStatus(status) {
            const statusElement = document.getElementById('server-status');
            statusElement.textContent = status;
        }
        
        function showNetworkError() {
            const errorElement = document.getElementById('network-error');
            errorElement.style.display = 'block';
        }
        
        function hideNetworkError() {
            const errorElement = document.getElementById('network-error');
            errorElement.style.display = 'none';
        }
        
        function handleServerMessage(data) {
            try {
                const message = JSON.parse(data);
                console.log('Received message:', message.type);
                
                switch (message.type) {
                    case 'registered':
                        playerId = message.playerId;
                        break;
                        
                    case 'room_created':
                        handleRoomCreated(message);
                        break;
                        
                    case 'room_joined':
                        handleRoomJoined(message);
                        break;
                        
                    case 'player_joined':
                        handlePlayerJoined(message);
                        break;
                        
                    case 'player_left':
                        handlePlayerLeft(message);
                        break;
                        
                    case 'player_ready':
                        handlePlayerReady(message);
                        break;
                        
                    case 'game_starting':
                        handleGameStarting(message);
                        break;
                        
                    case 'game_state':
                        handleGameState(message);
                        break;
                        
                    case 'game_over':
                        handleGameOver(message);
                        break;
                        
                    case 'error':
                        handleError(message);
                        break;
                }
            } catch (error) {
                console.error('Error parsing message:', error);
            }
        }
        
        function handleRoomCreated(message) {
            currentRoomCode = message.roomCode;
            isRoomHost = true;
            
            document.getElementById('room-code').textContent = currentRoomCode;
            document.getElementById('menu-screen').style.opacity = '0';
            document.getElementById('menu-screen').style.pointerEvents = 'none';
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('room-screen').style.display = 'flex';
            document.getElementById('room-screen').style.opacity = '1';
            document.getElementById('room-screen').style.pointerEvents = 'auto';
            
            // Show host controls
            document.getElementById('start-game-btn').style.display = 'block';
            document.getElementById('ready-btn').style.display = 'none';
            
            // Update player list
            updatePlayerList(message.players);
            
            gameState = 'room';
        }
        
        function handleRoomJoined(message) {
            currentRoomCode = message.roomCode;
            isRoomHost = false;
            
            document.getElementById('room-code').textContent = currentRoomCode;
            document.getElementById('menu-screen').style.opacity = '0';
            document.getElementById('menu-screen').style.pointerEvents = 'none';
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('room-screen').style.display = 'flex';
            document.getElementById('room-screen').style.opacity = '1';
            document.getElementById('room-screen').style.pointerEvents = 'auto';
            
            // Show player controls
            document.getElementById('start-game-btn').style.display = 'none';
            document.getElementById('ready-btn').style.display = 'block';
            
            // Update player list
            updatePlayerList(message.players);
            
            gameState = 'room';
        }
        
        function handlePlayerJoined(message) {
            // Update player list
            updatePlayerList(message.players);
            sounds.connect.play();
        }
        
        function handlePlayerLeft(message) {
            // Update player list
            updatePlayerList(message.players);
            sounds.disconnect.play();
            
            // If player was in game, remove their entity
            if (gameState === 'playing' && message.playerId) {
                removePlayerEntity(message.playerId);
            }
        }
        
        function handlePlayerReady(message) {
            // Update player list
            updatePlayerList(message.players);
        }
        
        function handleGameStarting(message) {
            startGameFromServer(message.gameState);
        }
        
        function handleGameState(message) {
            if (gameState !== 'playing') return;
            
            // Update game timer
            if (message.gameTimer !== undefined) {
                gameTimer = message.gameTimer;
                document.getElementById('time-display').textContent = formatTime(gameTimer);
                
                // Update safe radius
                safeRadius = message.safeRadius || safeRadius;
            }
            
            // Update entities
            if (message.entities) {
                updateEntitiesFromServer(message.entities);
            }
            
            // Update players
            if (message.players) {
                updatePlayersFromServer(message.players);
            }
        }
        
        function handleGameOver(message) {
            endGameFromServer(message.winners);
        }
        
        function handleError(message) {
            console.error('Server error:', message.error);
            
            // Handle specific errors
            if (message.error === 'Room not found') {
                alert('Phòng không tồn tại hoặc đã đóng.');
                document.getElementById('room-screen').style.opacity = '0';
                document.getElementById('room-screen').style.pointerEvents = 'none';
                document.getElementById('room-screen').style.display = 'none';
                document.getElementById('menu-screen').style.display = 'flex';
                document.getElementById('menu-screen').style.opacity = '1';
                document.getElementById('menu-screen').style.pointerEvents = 'auto';
                currentRoomCode = null;
                gameState = 'menu';
            }
        }
        
        function createRoom() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('Không thể kết nối đến máy chủ. Vui lòng thử lại sau.');
                return;
            }
            
            socket.send(JSON.stringify({
                type: 'create_room',
                name: playerName,
                sessionId: playerSessionId
            }));
        }
        
        function joinRoom(roomCode) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert('Không thể kết nối đến máy chủ. Vui lòng thử lại sau.');
                return;
            }
            
            socket.send(JSON.stringify({
                type: 'join_room',
                roomCode: roomCode,
                name: playerName,
                sessionId: playerSessionId
            }));
        }
        
        function leaveRoom() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'leave_room'
                }));
            }
            
            document.getElementById('room-screen').style.opacity = '0';
            document.getElementById('room-screen').style.pointerEvents = 'none';
            document.getElementById('room-screen').style.display = 'none';
            document.getElementById('menu-screen').style.display = 'flex';
            document.getElementById('menu-screen').style.opacity = '1';
            document.getElementById('menu-screen').style.pointerEvents = 'auto';
            document.getElementById('join-room-container').style.display = 'none';
            document.querySelector('.menu-buttons').style.display = 'flex';
            
            currentRoomCode = null;
            isRoomHost = false;
            isPlayerReady = false;
            gameState = 'menu';
        }
        
        function toggleReady() {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            isPlayerReady = !isPlayerReady;
            
            socket.send(JSON.stringify({
                type: 'toggle_ready',
                ready: isPlayerReady
            }));
            
            // Update local UI
            const playerList = document.getElementById('player-list');
            const players = playerList.querySelectorAll('.player-item');
            
            for (let i = 0; i < players.length; i++) {
                const player = players[i];
                if (player.dataset.playerId === playerId) {
                    const readyIndicator = player.querySelector('.player-ready');
                    if (isPlayerReady) {
                        readyIndicator.classList.remove('not-ready');
                        readyIndicator.classList.add('ready');
                    } else {
                        readyIndicator.classList.remove('ready');
                        readyIndicator.classList.add('not-ready');
                    }
                    break;
                }
            }
        }
        
        function startGame() {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            socket.send(JSON.stringify({
                type: 'start_game'
            }));
        }
        
        function updatePlayerList(players) {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.className = 'player-item';
                playerItem.dataset.playerId = player.id;
                
                const isCurrentPlayer = player.id === playerId;
                
                playerItem.innerHTML = `
                    <div class="player-avatar">${player.name.charAt(0)}</div>
                    <div class="player-name">${player.name}${isCurrentPlayer ? ' (Bạn)' : ''}</div>
                    <div class="player-ready ${player.ready ? 'ready' : 'not-ready'}"></div>
                `;
                
                playerList.appendChild(playerItem);
            });
            
            document.getElementById('player-count').textContent = `Đang chờ người chơi... (${players.length}/5)`;
            
            // Enable start button if host and at least 2 players and all are ready
            if (isRoomHost) {
                const allReady = players.every(player => player.ready || player.id === playerId);
                const startBtn = document.getElementById('start-game-btn');
                
                if (players.length >= 2 && allReady) {
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-50');
                } else {
                    startBtn.disabled = true;
                    startBtn.classList.add('opacity-50');
                }
            }
        }
        
        function startGameFromServer(initialGameState) {
            // Prepare game world
            app.stage.removeChildren();
            
            // Create game world container
            const world = new PIXI.Container();
            app.stage.addChild(world);
            
            // Create background
            createBackground(world);
            
            // Create game entities from server data
            createEntitiesFromServer(world, initialGameState);
            
            // Update UI
            document.getElementById('health-bar').style.width = '100%';
            document.getElementById('flower-count').textContent = '0';
            document.getElementById('time-display').textContent = formatTime(initialGameState.gameTimer || 120);
            
            // Switch to game screen
            document.getElementById('room-screen').style.opacity = '0';
            document.getElementById('room-screen').style.pointerEvents = 'none';
            document.getElementById('room-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('game-screen').style.opacity = '1';
            document.getElementById('game-screen').style.pointerEvents = 'auto';
            
            // Start game loop
            gameState = 'playing';
            gameTimer = initialGameState.gameTimer || 120;
            safeRadius = initialGameState.safeRadius || 1000;
            
            // Set up game loop
            app.ticker.add(gameLoop);
            
            // Center camera on player
            centerCamera();
        }
        
        function createEntitiesFromServer(world, gameState) {
            entities = [];
            remotePlayers = new Map();
            
            // Create player entities
            gameState.players.forEach(playerData => {
                const isCurrentPlayer = playerData.id === playerId;
                const player = createPlayer(playerData.x, playerData.y, playerData.name, isCurrentPlayer);
                
                world.addChild(player.sprite);
                entities.push(player);
                
                if (isCurrentPlayer) {
                    playerEntity = player;
                    playerHealth = playerData.health;
                    flowerCount = playerData.flowers;
                } else {
                    remotePlayers.set(playerData.id, player);
                }
                
                // Update player stats
                player.health = playerData.health;
                player.flowers = playerData.flowers;
                player.updateHealth();
            });
            
            // Create obstacles
            gameState.obstacles.forEach(obstacle => {
                const obstacleEntity = createObstacle(obstacle.x, obstacle.y, obstacle.type);
                world.addChild(obstacleEntity.sprite);
                entities.push(obstacleEntity);
            });
            
            // Create flowers
            gameState.flowers.forEach(flower => {
                const flowerEntity = createFlower(flower.x, flower.y);
                flowerEntity.id = flower.id;
                flowerEntity.collected = flower.collected;
                
                if (flowerEntity.collected) {
                    flowerEntity.sprite.visible = false;
                }
                
                world.addChild(flowerEntity.sprite);
                entities.push(flowerEntity);
            });
            
            // Create power-ups
            gameState.powerups.forEach(powerup => {
                const powerupEntity = createPowerup(powerup.x, powerup.y);
                powerupEntity.id = powerup.id;
                powerupEntity.collected = powerup.collected;
                
                if (powerupEntity.collected) {
                    powerupEntity.sprite.visible = false;
                }
                
                world.addChild(powerupEntity.sprite);
                entities.push(powerupEntity);
            });
            
            // Create hearts
            gameState.hearts.forEach(heart => {
                const heartEntity = createHeart(heart.x, heart.y);
                heartEntity.id = heart.id;
                heartEntity.collected = heart.collected;
                
                if (heartEntity.collected) {
                    heartEntity.sprite.visible = false;
                }
                
                world.addChild(heartEntity.sprite);
                entities.push(heartEntity);
            });
        }
        
        function updateEntitiesFromServer(serverEntities) {
            // Update collectibles
            serverEntities.forEach(serverEntity => {
                if (serverEntity.type === 'flower' || serverEntity.type === 'powerup' || serverEntity.type === 'heart') {
                    const entity = entities.find(e => e.id === serverEntity.id && e.type === serverEntity.type);
                    
                    if (entity) {
                        entity.collected = serverEntity.collected;
                        entity.sprite.visible = !serverEntity.collected;
                    } else if (!serverEntity.collected) {
                        // New entity that we don't have yet
                        let newEntity;
                        
                        if (serverEntity.type === 'flower') {
                            newEntity = createFlower(serverEntity.x, serverEntity.y);
                        } else if (serverEntity.type === 'powerup') {
                            newEntity = createPowerup(serverEntity.x, serverEntity.y);
                        } else if (serverEntity.type === 'heart') {
                            newEntity = createHeart(serverEntity.x, serverEntity.y);
                        }
                        
                        if (newEntity) {
                            newEntity.id = serverEntity.id;
                            app.stage.children[0].addChild(newEntity.sprite);
                            entities.push(newEntity);
                        }
                    }
                }
            });
        }
        
        function updatePlayersFromServer(players) {
            players.forEach(playerData => {
                if (playerData.id === playerId) {
                    // Update local player
                    if (playerEntity) {
                        playerEntity.health = playerData.health;
                        playerEntity.flowers = playerData.flowers;
                        playerEntity.updateHealth();
                        flowerCount = playerData.flowers;
                        document.getElementById('flower-count').textContent = flowerCount;
                    }
                } else {
                    // Update remote player
                    const remotePlayer = remotePlayers.get(playerData.id);
                    
                    if (remotePlayer) {
                        // Update position
                        remotePlayer.x = playerData.x;
                        remotePlayer.y = playerData.y;
                        remotePlayer.sprite.x = playerData.x;
                        remotePlayer.sprite.y = playerData.y;
                        
                        // Update stats
                        remotePlayer.health = playerData.health;
                        remotePlayer.flowers = playerData.flowers;
                        remotePlayer.updateHealth();
                        
                        // Handle player death
                        if (playerData.isDead) {
                            remotePlayer.isDead = true;
                            remotePlayer.sprite.visible = false;
                        }
                    }
                }
            });
        }
        
        function removePlayerEntity(playerId) {
            const remotePlayer = remotePlayers.get(playerId);
            
            if (remotePlayer) {
                // Remove player sprite from stage
                app.stage.children[0].removeChild(remotePlayer.sprite);
                
                // Remove from entities array
                const index = entities.findIndex(e => e === remotePlayer);
                if (index !== -1) {
                    entities.splice(index, 1);
                }
                
                // Remove from remotePlayers map
                remotePlayers.delete(playerId);
            }
        }
        
        function createBackground(world) {
            // Create a large rectangle for the ground
            const ground = new PIXI.Graphics();
            ground.beginFill(0x8BC34A);
            ground.drawRect(-2000, -2000, 4000, 4000);
            ground.endFill();
            world.addChild(ground);
            
            // Add some decorative elements
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * 4000 - 2000;
                const y = Math.random() * 4000 - 2000;
                
                const decoration = new PIXI.Graphics();
                decoration.beginFill(0x9CCC65);
                decoration.drawCircle(0, 0, Math.random() * 20 + 10);
                decoration.endFill();
                decoration.x = x;
                decoration.y = y;
                world.addChild(decoration);
            }
            
            // Draw the initial safe zone
            const safeZone = new PIXI.Graphics();
            safeZone.lineStyle(5, 0xFF6B8B, 0.8);
            safeZone.drawCircle(0, 0, safeRadius);
            world.addChild(safeZone);
            
            // Update safe zone during game
            app.ticker.add(() => {
                if (gameState === 'playing') {
                    safeZone.clear();
                    safeZone.lineStyle(5, 0xFF6B8B, 0.8);
                    safeZone.drawCircle(0, 0, safeRadius);
                    
                    // Draw danger zone
                    safeZone.beginFill(0xFF6B8B, 0.2);
                    safeZone.drawCircle(0, 0, safeRadius);
                    safeZone.endFill();
                }
            });
        }
        
        function createPlayer(x, y, name, isPlayer) {
            const texture = PIXI.Texture.from(ASSETS.chickenAvatar);
            const sprite = new PIXI.Sprite(texture);
            sprite.anchor.set(0.5);
            sprite.x = x;
            sprite.y = y;
            
            // Add name text
            const nameText = new PIXI.Text(name, {
                fontFamily: 'Quicksand',
                fontSize: 14,
                fill: 0x333333,
                align: 'center',
                fontWeight: 'bold'
            });
            nameText.anchor.set(0.5, 0);
            nameText.y = 25;
            sprite.addChild(nameText);
            
            // Add health bar
            const healthBar = new PIXI.Graphics();
            healthBar.beginFill(0x4CAF50);
            healthBar.drawRect(-20, -30, 40, 5);
            healthBar.endFill();
            sprite.addChild(healthBar);
            
            return {
                sprite,
                nameText,
                healthBar,
                x,
                y,
                vx: 0,
                vy: 0,
                speed: isPlayer ? 5 : 4,
                health: 100,
                flowers: 0,
                type: 'player',
                isPlayer,
                name,
                isDead: false,
                invulnerable: false,
                invulnerableTimer: 0,
                updateHealth: function() {
                    this.healthBar.clear();
                    this.healthBar.beginFill(0x4CAF50);
                    this.healthBar.drawRect(-20, -30, 40 * (this.health / 100), 5);
                    this.healthBar.endFill();
                    
                    if (this.isPlayer) {
                        document.getElementById('health-bar').style.width = `${this.health}%`;
                    }
                }
            };
        }
        
        function createObstacle(x, y, type = null) {
            const obstacleTypes = [ASSETS.obstacleTree, ASSETS.obstacleBush, ASSETS.obstacleRock];
            let texture;
            
            if (type === 'tree') {
                texture = PIXI.Texture.from(ASSETS.obstacleTree);
            } else if (type === 'bush') {
                texture = PIXI.Texture.from(ASSETS.obstacleBush);
            } else if (type === 'rock') {
                texture = PIXI.Texture.from(ASSETS.obstacleRock);
            } else {
                texture = PIXI.Texture.from(obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)]);
            }
            
            const sprite = new PIXI.Sprite(texture);
            sprite.anchor.set(0.5);
            sprite.x = x;
            sprite.y = y;
            
            return {
                sprite,
                x,
                y,
                vx: 0,
                vy: 0,
                type: 'obstacle',
                radius: sprite.width / 2
            };
        }
        
        function createFlower(x, y) {
            const texture = PIXI.Texture.from(ASSETS.flower);
            const sprite = new PIXI.Sprite(texture);
            sprite.anchor.set(0.5);
            sprite.x = x;
            sprite.y = y;
            
            return {
                sprite,
                x,
                y,
                vx: 0,
                vy: 0,
                type: 'flower',
                collected: false,
                value: 1
            };
        }
        
        function createPowerup(x, y) {
            const texture = PIXI.Texture.from(ASSETS.powerup);
            const sprite = new PIXI.Sprite(texture);
            sprite.anchor.set(0.5);
            sprite.x = x;
            sprite.y = y;
            
            // Add animation
            app.ticker.add(() => {
                sprite.rotation += 0.01;
            });
            
            return {
                sprite,
                x,
                y,
                vx: 0,
                vy: 0,
                type: 'powerup',
                collected: false
            };
        }
        
        function createHeart(x, y) {
            const texture = PIXI.Texture.from(ASSETS.heart);
            const sprite = new PIXI.Sprite(texture);
            sprite.anchor.set(0.5);
            sprite.x = x;
            sprite.y = y;
            
            // Add animation
            let scale = 1;
            let growing = false;
            app.ticker.add(() => {
                if (growing) {
                    scale += 0.005;
                    if (scale >= 1.2) growing = false;
                } else {
                    scale -= 0.005;
                    if (scale <= 0.8) growing = true;
                }
                sprite.scale.set(scale);
            });
            
            return {
                sprite,
                x,
                y,
                vx: 0,
                vy: 0,
                type: 'heart',
                collected: false
            };
        }
        
        function gameLoop(delta) {
            if (gameState !== 'playing') return;
            
            // Process input and update entities
            movePlayer();
            updateEntities();
            checkCollisions();
            
            // Center camera on player
            centerCamera();
        }
        
        function movePlayer() {
            if (!playerEntity || playerEntity.isDead) return;
            
            playerEntity.x += playerEntity.vx;
            playerEntity.y += playerEntity.vy;
            
            playerEntity.sprite.x = playerEntity.x;
            playerEntity.sprite.y = playerEntity.y;
        }
        
        function updateEntities() {
            entities.forEach(entity => {
                if (entity.invulnerable) {
                    entity.invulnerableTimer -= 1;
                    entity.sprite.alpha = Math.sin(entity.invulnerableTimer * 0.2) * 0.5 + 0.5;
                    
                    if (entity.invulnerableTimer <= 0) {
                        entity.invulnerable = false;
                        entity.sprite.alpha = 1;
                    }
                }
                
                if (entity.type === 'flower' || entity.type === 'powerup' || entity.type === 'heart') {
                    if (entity.collected) {
                        entity.sprite.visible = false;
                    }
                }
            });
        }
        
        function centerCamera() {
            if (!playerEntity) return;
            
            app.stage.x = window.innerWidth / 2 - playerEntity.x;
            app.stage.y = window.innerHeight / 2 - playerEntity.y;
        }
        
        function checkCollisions() {
            if (!playerEntity || playerEntity.isDead) return;
            
            // Check for collisions with collectibles
            for (let i = 0; i < entities.length; i++) {
                const entity = entities[i];
                
                if ((entity.type === 'flower' || entity.type === 'powerup' || entity.type === 'heart') && 
                    !entity.collected) {
                    const dx = playerEntity.x - entity.x;
                    const dy = playerEntity.y - entity.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 30) {
                        // Collect item and notify server
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            socket.send(JSON.stringify({
                                type: 'collect',
                                itemType: entity.type,
                                itemId: entity.id
                            }));
                            
                            entity.collected = true;
                            entity.sprite.visible = false;
                            
                            if (entity.type === 'flower') {
                                sounds.flower.play();
                                flowerCount++;
                                document.getElementById('flower-count').textContent = flowerCount;
                            }
                        }
                    }
                }
                
                // Player collisions with obstacles
                if (entity.type === 'obstacle') {
                    const dx = playerEntity.x - entity.x;
                    const dy = playerEntity.y - entity.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 40) {
                        // Push player away from obstacle
                        const pushFactor = 1;
                        playerEntity.x += (dx / distance) * pushFactor;
                        playerEntity.y += (dy / distance) * pushFactor;
                    }
                }
            }
            
            // Check for out of safe zone damage
            const distanceFromCenter = Math.sqrt(playerEntity.x * playerEntity.x + playerEntity.y * playerEntity.y);
            if (distanceFromCenter > safeRadius && !playerEntity.invulnerable) {
                // Take damage
                playerEntity.health -= 0.5;
                playerHealth = playerEntity.health;
                playerEntity.updateHealth();
                
                if (playerEntity.health <= 0) {
                    playerEntity.isDead = true;
                    socket.send(JSON.stringify({
                        type: 'player_dead'
                    }));
                }
            }
        }
        
        function collectFlower() {
            if (gameState !== 'playing' || !playerEntity || playerEntity.isDead) return;
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'action',
                    action: 'collect_flower'
                }));
            }
        }
        
        function endGameFromServer(winners) {
            sounds.win.play();
            gameState = 'ended';
            
            // Stop game loop
            app.ticker.remove(gameLoop);
            
            // Update winners list
            const winnersList = document.getElementById('winners-list');
            winnersList.innerHTML = '';
            
            winners.slice(0, 3).forEach((winner, index) => {
                const position = index + 1;
                const isCurrentPlayer = winner.id === playerId;
                
                const winnerItem = document.createElement('div');
                winnerItem.className = 'winner-item';
                winnerItem.innerHTML = `
                    <div class="winner-position position-${position}">${position}</div>
                    <div class="winner-name">${winner.name}${isCurrentPlayer ? ' (Bạn)' : ''}</div>
                    <div class="winner-score">${winner.flowers} Hoa</div>
                `;
                winnersList.appendChild(winnerItem);
            });
            
            // Show results screen
            document.getElementById('game-screen').style.opacity = '0';
            document.getElementById('game-screen').style.pointerEvents = 'none';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('results-screen').style.display = 'flex';
            document.getElementById('results-screen').style.opacity = '1';
            document.getElementById('results-screen').style.pointerEvents = 'auto';
            
            // Reset game state
            currentRoomCode = null;
            isRoomHost = false;
            isPlayerReady = false;
        }
        
        // Utility functions
        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substring(2, 15);
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function generateRoomCode() {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }
    </script>
</body>
</html>
